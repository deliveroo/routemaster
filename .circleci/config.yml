version: 2

job_defaults: &job_defaults
  working_directory: /routemaster
  docker:
    - image: deliveroo/circleci:0.1.8

step_defaults: &step_defaults
  - setup_remote_docker:
      docker_version: 17.06.0-ce
      reusable: true

jobs:
  run_test_suite:
    <<: *job_defaults

    steps:
      <<: *step_defaults
      - checkout
      - run: ci down
      - run: ci build
      - run: ci run --rm wait wfi redis:6379
      - run: ci run --rm app bin/test_and_report

  build_image:
    <<: *job_defaults

    steps:
      <<: *step_defaults
      - checkout
      - run: echo BUILT

workflows:
  version: 2
  test_and_build:
    jobs:
      - run_test_suite
      - build_image:
          requires:
            - run_ci
